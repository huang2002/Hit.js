Extension.export("Game-Scene",new Constructor(function(){this._agency=new Agency,this._agency.bind(this),this.items=[],this.bg=null,this.fps=null},{add:function(t){return this.items.push(t),this},remove:function(t){return this.items=Loop.filter(this.items,function(i){return i!==t}),this},drawBg:function(t,i){this.bg&&i&&(t.save(),t.fillStyle=this.bg,t.fillRect(0,0,i.width,i.height),t.restore())},draw:function(t){Loop.each(this.items,function(i){"draw"in i&&i.draw(t)})}})),Extension.export("Game-Controller",new Constructor(function(t){if(!t)return null;var i=new Ani.Frame;this.frame=i,this.scene=null;var n=this;i.listen("update",function(){if(n.scene){var e=t.context,h=t.UI,o=n.scene;if(o.fps>0&&(i.fps=o.fps),o.drawBg(e,h),o._agency.trigger("update"),o.draw(e),t.debugInfo){e.save(),e.font=t.debugInfoFont,e.fillStyle=t.debugInfoColor,e.textAlign="left",e.textBaseline="top";var r=t.debugInfoX,s=t.debugInfoY,d=t.debugInfoLineHeight;Loop.each(["frame duration: "+i.lastFrameDuration,"real fps:       "+Math.round(1e3/i.lastUpdateGap),"items count:    "+o.items.length],function(t,i){e.fillText(t,r,s+d*i)}),e.restore()}}}),this.listenType=function(i){window.listen(i,function(e){if(n.frame.isRunning){var h="touches"in e?e.touches[0]:e,o=t.UI.toGameX(h.clientX),r=t.UI.toGameY(h.clientY),s=n.scene;s._agency.trigger(i,[e]),Loop.each(s.items,function(t){"_agency"in t&&"isPointInPath"in t&&t.isPointInPath(o,r)&&t._agency.trigger(i,[e])})}})},this.listenType("click")},{start:function(t){return t&&(this.scene&&this.scene._agency.trigger("exit"),this.scene=t,this.scene._agency.trigger("enter")),this.frame.isRunning||this.frame.start(),this},stop:function(){return this.frame.stop(),this},direct:function(t){return this.start(Extension.import(t))}})),Extension.export("Game-UI",new Constructor(function(t){this.width=960,this.height=640,this.padding=5,Object.defineProperties(this,{left:{get:function(){return 0}},top:{get:function(){return 0}},right:{get:function(){return this.width}},bottom:{get:function(){return this.height}},cx:{get:function(){return this.width/2}},cy:{get:function(){return this.height/2}}});var i=t._canvas;this.toGameX=function(t){var n=i.getBoundingClientRect();return(t-n.left)/n.width*this.width},this.toGameY=function(t){var n=i.getBoundingClientRect();return(t-n.top)/n.height*this.height}},{toGamePos:function(t){return{x:this.toGameX(t.x),y:this.toGameY(t.y)}}})),Extension.define("Game",["Game-Controller","Game-UI"],function(t,i){var n=new Constructor(function(){this._canvas=DOM.create("canvas.game"),this.context=this._canvas.getContext("2d"),this.controller=new t(this),this.UI=new i(this),this.debugInfo=!1,this.debugInfoFont="18px Consolas",this.debugInfoColor="#00f",this.debugInfoLineHeight=25,this.debugInfoX=10,this.debugInfoY=10},{init:function(t){try{t=t||{},t.width>0&&(this.UI.width=t.width),t.height>0&&(this.UI.height=t.height),t.padding>0&&(this.UI.padding=t.padding),"method"in t||(t.method=n.FIXED);var i=this._canvas,e=document.body,h=window.devicePixelRatio||1,o=function(){var n=t.method(this.UI);if(i.width=this.UI.width*h,i.height=this.UI.height*h,i.css("margin-left",n.left+"px"),i.css("margin-top",n.top+"px"),i.css("width",n.width+"px"),i.css("height",n.height+"px"),this.context.scale(h,h),"screen"in window){var o=window.screen;o.height&&(e.style.height=o.height+"px")}}.bind(this);o(),t.autoResize!==!1&&(window.listen("resize",o),window.listen("orientationchange",o)),e.appendChild(i)}catch(t){return console.error(t),!1}return!0}});return Loop.each({FIXED:function(t){var i=window.innerWidth,n=window.innerHeight,e=t.width,h=t.height,o=t.padding,r={},s=null;return i/n>e/h?(r.height=n-2*o,r.top=o,s=r.height/h,r.width=e*s,r.left=i/2-r.width/2):(r.width=i-2*o,r.left=o,s=r.width/e,r.height=h*s,r.top=n/2-r.height/2),r},FIXED_HEIGHT:function(t){var i=window.innerWidth,n=window.innerHeight,e=t.height,h=t.padding,o={},r=null;return o.height=n-2*h,o.top=h,r=o.height/e,o.width=i-2*h,t.width=o.width/r,o.left=h,o},FIXED_WIDTH:function(t){var i=window.innerWidth,n=window.innerHeight,e=t.width,h=t.padding,o={},r=null;return o.width=i-2*h,o.left=h,r=o.width/e,o.height=n-2*h,t.height=o.height/r,o.top=h,o},MIN:function(t){return{width:t.width,height:t.height,left:window.innerWidth/2-t.width/2,top:window.innerHeight/2-t.height/2}},MAX:function(t){return{left:t.padding,top:t.padding,width:t.width=window.innerWidth-2*t.padding,height:t.height=window.innerHeight-2*t.padding}}},function(t,i){n[i]=t}),n});