if(!("OC"in window))throw new Error("Please load OC.js first!");Extension.export("Game-Scene",new Constructor(function(){this._agency=new Agency,this._agency.bind(this),this.items=[],this.bg=null,this.fps=null},{add:function(t){return this.items.push(t),this},remove:function(t){return this.items=Loop.filter(this.items,function(i){return i!==t}),this},draw:function(t,i){this.bg&&i&&(t.save(),t.fillStyle=this.bg,t.fillRect(0,0,i.width,i.height),t.restore()),Loop.each(this.items,function(i){"draw"in i&&i.draw(t)})}})),Extension.export("Game-Controller",new Constructor(function(t){if(!t)return null;this.frame=new Ani.Frame,this.scene=null;var i=this;this.frame.listen("update",function(){if(i.scene){var n=t.context,e=t.UI,h=i.scene;h.fps>0&&(i.frame.fps=h.fps),h._agency.trigger("update"),h.draw(n,e)}}),this.listenType=function(n){window.listen(n,function(e){if(i.frame.isRunning){var h="touches"in e?e.touches[0]:e,r=t.UI.toGameX(h.clientX),o=t.UI.toGameY(h.clientY),s=i.scene;s._agency.trigger(n,[e]),Loop.each(s.items,function(t){"_agency"in t&&"isPointInPath"in t&&t.isPointInPath(r,o)&&t._agency.trigger(n,[e])})}})},this.listenType("click")},{start:function(t){return t&&(this.scene&&this.scene._agency.trigger("exit"),this.scene=t,this.scene._agency.trigger("enter")),this.frame.isRunning||this.frame.start(),this},stop:function(){return this.frame.stop(),this},direct:function(t){return this.start(Extension.import(t))}})),Extension.export("Game-UI",new Constructor(function(t){this.width=960,this.height=640,this.padding=5,Object.defineProperties(this,{left:{get:function(){return 0}},top:{get:function(){return 0}},right:{get:function(){return this.width}},bottom:{get:function(){return this.height}},cx:{get:function(){return this.width/2}},cy:{get:function(){return this.height/2}}});var i=t._canvas;this.toGameX=function(t){var n=i.getBoundingClientRect();return(t-n.left)/n.width*this.width},this.toGameY=function(t){var n=i.getBoundingClientRect();return(t-n.top)/n.height*this.height}},{toGamePos:function(t){return{x:this.toGameX(t.x),y:this.toGameY(t.y)}}})),Extension.define("Game",["Game-Controller","Game-UI"],function(t,i){var n=new Constructor(function(){this._canvas=DOM.create("canvas.game"),this.context=this._canvas.getContext("2d"),this.controller=new t(this),this.UI=new i(this)},{init:function(t){try{t=t||{},t.width>0&&(this.UI.width=t.width),t.height>0&&(this.UI.height=t.height),t.padding>0&&(this.UI.padding=t.padding),"method"in t||(t.method=n.FIXED);var i=this._canvas,e=window.devicePixelRatio||1,h=function(){var n=t.method(this.UI);i.width=this.UI.width*e,i.height=this.UI.height*e,i.css("margin-left",n.left+"px"),i.css("margin-top",n.top+"px"),i.css("width",n.width+"px"),i.css("height",n.height+"px"),this.context.scale(e,e)}.bind(this);h(),t.autoResize!==!1&&(window.listen("resize",h),window.listen("orientationchange",h)),document.body.appendChild(i)}catch(t){return console.error(t),!1}return!0}});return Loop.each({FIXED:function(t){var i=window.innerWidth,n=window.innerHeight,e=t.width,h=t.height,r=t.padding,o={},s=null;return i/n>e/h?(o.height=n-2*r,o.top=r,s=o.height/h,o.width=e*s,o.left=i/2-o.width/2):(o.width=i-2*r,o.left=r,s=o.width/e,o.height=h*s,o.top=n/2-o.height/2),o},FIXED_HEIGHT:function(t){var i=window.innerWidth,n=window.innerHeight,e=t.height,h=t.padding,r={},o=null;return r.height=n-2*h,r.top=h,o=r.height/e,r.width=i-2*h,t.width=r.width/o,r.left=h,r},FIXED_WIDTH:function(t){var i=window.innerWidth,n=window.innerHeight,e=t.width,h=t.padding,r={},o=null;return r.width=i-2*h,r.left=h,o=r.width/e,r.height=n-2*h,t.height=r.height/o,r.top=h,r},MIN:function(t){return{width:t.width,height:t.height,left:window.innerWidth/2-t.width/2,top:window.innerHeight/2-t.height/2}},MAX:function(t){return t.width=window.innerWidth-2*t.padding,t.height=window.innerHeight-2*t.padding,{left:t.padding,top:t.padding,width:t.width,height:t.height}}},function(t,i){n[i]=t}),n});