Extension.define("World",[],function(){"use strict";var t=new Constructor(function(){this.collisionListeners={}},{addCollisionListener:function(t,e){t=""+t;var n=this.collisionListeners;return t in n?n[t].add(e):n[t]=new Set([e]),this},removeCollisionListener:function(t,e){var n=this.collisionListeners;return t in n&&n[t].delete(e),this},collideWith:function(t){var e=t.tag,n=this.collisionListeners;return e in n&&n[e].forEach(function(e){e(t)}),this}}),e=new Constructor(function(){this.items=new Set,this.lastUpdateTime=null,this.updateBasis=16},{init:function(){return this.lastUpdateTime=+new Date,this.items.forEach(function(t){t.trigger("init")}),this},update:function(t){var e=+new Date,n=e-this.lastUpdateTime,i=n/this.updateBasis;return"number"==typeof t&&(i*=t),this.lastUpdateTime=e,this.items.forEach(function(t){t.trigger("update"),t.update(i)}),this},checkCollisions:function(t){t=t||new Set("*");var e=this.items,n=new Set,i=Math.distance_p;return e.forEach(function(r){var s=r.pos;n.add(r),r.matchTags(t)&&e.forEach(function(e){if(!n.has(e)){if(!e.matchTags(t))return n.add(e);var a=e.pos;if(!(i(s,a)>r.r+e.r)){var o=r.checkCollision(e);if(o){var c=o.reduce(function(t,e){return t.getLen()<e.getLen()?t:e});r.collideWith(e),e.collideWith(r);var h=r.active,u=e.active;if(h||u){if(!r.penetrative&&u){var f=e.v.getLen(),l=(e.m,c.clone().scale(-1));e.pos.addVec(l.clone().scale(h?.5:1)),e.v.addVec(l.setLen(f*e.flex)),e.a.set(0,0)}if(!e.penetrative&&h){var d=r.v.getLen(),g=(e.m,c);r.pos.addVec(g.clone().scale(u?.5:1)),r.v.addVec(g.setLen(d*r.flex)),r.a.set(0,0)}}}}}})}),this},stroke:function(t,e){return e=e||new Set("*"),this.items.forEach(function(n){n.matchTags(e)&&n.getRealOutline().stroke(t)}),this},fill:function(t,e){return e=e||new Set("*"),this.items.forEach(function(n){n.matchTags(e)&&n.getRealOutline().fill(t)}),this},draw:function(t,e){return e=e||new Set("*"),this.items.forEach(function(n){n.matchTags(e)&&n.getRealOutline().draw(t)}),this}},[t]),n=e.checkCollision=function(t,e){var n=!0,i=[],s=Math,a=s.PI,o=t.getRealOutline(),c=e.getRealOutline(),h=o.isClockwise(),u=c.isClockwise(),f=new Set,l=Loop.map(o.getEdges(),function(t){return{r:t.getRad(),c:h}}).concat(Loop.map(c.getEdges(),function(t){return{r:t.getRad(),c:u}}));return l=Loop.filter(l,function(t){var e=f.size;return f.add(t.r),f.size>e}),l.forEach(function(t){if(n){var e=t.r,s=o.clone().rotRad(-e).getBox(),h=c.clone().rotRad(-e).getBox();if(h.r>s.r)if(h.x>=s.r)n=!1;else{var u=s.r-h.x;i.push(new r(0,-u).rotRad(e+(t.c?-1:1)*a/2))}else if(s.x>=h.r)n=!1;else{var u=h.r-s.x;i.push(new r(0,u).rotRad(e+(t.c?-1:1)*a/2))}}}),n&&i},i=e.Outline=new Constructor(function(t){this.vertices=t||[],this.strokeStyle="rgba(0,0,255,.9)",this.fillStyle="rgba(33,144,255,.1)"},{addVertex:function(t,e){return this.vertices.push(new r(t,e)),this},addVertices:function(t){return Loop.each(t,function(t){this.vertices.push(new r(t.x,t.y))},this),this},addVerticesArr:function(t){return this.addVertices(t.split(2).map(function(t){return{x:t[0],y:t[1]}}))},translate:function(t,e){return Loop.each(this.vertices,function(n){n.add(t,e)}),this},translateVec:function(t){return this.translate(t.x,t.y)},rotRad:function(t){return Loop.each(this.vertices,function(e){e.rotRad(t)}),this},rotDeg:function(t){return this.rotRad(t/180*Math.PI)},getBox:function(){var t=this.vertices,e=t[0].x,n=t[0].x,i=t[0].y,r=t[0].y;return Loop.repeat({from:1,to:t.length-1},function(s){var a=t[s],o=a.x,c=a.y;o<e?e=o:o>n&&(n=o),c<i?i=c:c>r&&(r=c)}),{x:e,y:i,r:n,b:r}},path:function(t){return Loop.each(this.vertices,function(e,n){t[0===n?"moveTo":"lineTo"](e.x,e.y)}),this},stroke:function(t){return t.save(),t.beginPath(),this.path(t),t.closePath(),t.strokeStyle=this.strokeStyle,t.stroke(),t.restore(),this},fill:function(t){return t.save(),t.beginPath(),this.path(t),t.closePath(),t.fillStyle=this.fillStyle,t.fill(),t.restore(),this},draw:function(t){return this.fill(t).stroke(t)},isClockwise:function(){var t=this.vertices;return t.length<2||t[0].getRad()<t[1].getRad()},getEdges:function(){var t=this.vertices;return t.length<2?[]:Loop.map(t,function(e,n){var i=t.at(n+1);return new r(i.x-e.x,i.y-e.y)})},clone:function(){return new i(Loop.map(this.vertices,function(t){return new r(t.x,t.y)}))}});i.regPoly=function(t,e){var n=Math,i=2*n.PI/t,s=n.PI;return Loop.repeat({from:.5,to:t-.5},function(t){var a=t*i-s;return new r(e*n.sin(a),e*n.cos(a))})};var r=e.Vector=new Constructor(function(t,e){this.x=t||0,this.y=e||0},{set:function(t,e){return this.x=t,this.y=e,this},setVec:function(t){return this.set(t.x,t.y)},add:function(t,e){return this.x+=t,this.y+=e,this},addVec:function(t){return this.add(t.x,t.y)},getLen:function(){return Math.distance(0,0,this.x,this.y)},scale:function(t){return this.x*=t,this.y*=t,this},setLen:function(t){return this.scale(t/this.getLen())},getRad:function(){if(!(this.getLen()>0))return NaN;var t=Math,e=t.PI,n=this.x,i=this.y,r=NaN;return 0===n?r=i>0?e:0:0===i?r=n>0?e/2:1.5*e:n>0&&i<0?r=t.atan(-n/i):n>0&&i>0?r=t.atan(i/n)+e/2:n<0&&i>0?r=t.atan(-n/i)+e:n<0&&i<0&&(r=t.atan(i/n)+1.5*e),r%(2*e)},getDeg:function(){return this.getRad()/Math.PI*180},rotRad:function(t){var e=Math;t%=e.PI;var n=this.getRad()+t,i=this.getLen();return this.x=i*e.sin(n),this.y=-i*e.cos(n),this},rotDeg:function(t){return this.rotRad(t/180*Math.PI)},clone:function(){return new r(this.x,this.y)}});r.mix=function(t){var e=0,n=0;return t.forEach(function(t){e+=t.x,n+=t.y}),new r(e,n)},r.avg=function(t){var e=t.length,n=0,i=0;return t.forEach(function(t){n+=t.x,i+=t.y}),n/=e,i/=e,new r(n,i)};e.Item=new Constructor(function(t,e){if("*"===t)throw new Error("Illegal tag!");this.r=100,this.active=!1,this.penetrative=!1,this.flex=.5,this.m=5,this.g=2,this.resistance=.2,this.maxV=60,this.maxA=60,this.tag=""+t,this.pos=new r,this.a=new r,this.v=new r,this.forces=new Set,this.outline=new i(e)},{update:function(t){if(this.active){var e=this.v,n=this.a,i=this.m,s=r.mix(this.forces).scale(1/i).add(0,this.g);n.setVec(s);var a=n.getLen(),o=this.maxA;a>o&&n.scale(o/a),e.addVec(n);var c=e.getLen(),h=this.maxV;c>h&&e.scale(h/c),this.pos.addVec(e.clone().scale(t)),c>0&&e.scale(1-this.resistance)}else this.a.set(0,0),this.v.set(0,0);return this},matchTag:function(t){return this.tag===t||"*"===t},matchTags:function(t){return t.has("*")||t.has(this.tag)},checkCollision:function(t){return n(this,t)},getRealOutline:function(){return this.outline.clone().translateVec(this.pos)},path:function(t){return this.getRealOutline().path(t),this}},[t,Agency]);return e});